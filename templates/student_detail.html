{% extends 'base.html' %}
{% block content %}
<h2>Find Student by Reg No</h2>
<form method="post">
  {% csrf_token %}
  <label>Enter Registration No:</label>
  <input type="text" name="reg_no">
  <button type="submit">Search</button>
</form>

{% if student %}
    <div class="container mt-4">
    <div class="row">
      <!-- Student Info -->
      <div class="col-md-4">
        <div class="card shadow p-3 mb-4 rounded-3">
          <div class="d-flex align-items-center">
            {% if student.photo %}
              <img src="{{ student.photo.url }}" class="rounded-circle me-3" width="60" height="60">
            {% else %}
              <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center" style="width:60px;height:60px;">
                {{ student.name|slice:":1" }}
              </div>
            {% endif %}
            <div>
              <h6>Hello {{ student.name }}!</h6>
              <small>Reg No: {{ student.reg_no }}</small><br>
              <small>{{ student.course }}</small><br>
              <small>Semester: {{ student.semester }} | {{ student.academic_year }}</small>
            </div>
          </div>
        </div>
      </div>

      <!-- CGPA -->
      <div class="col-md-4">
        <div class="card shadow p-3 mb-4 text-center rounded-3">
          <h6>Overall CGPA:</h6>
          <h1 class="fw-bold">{{ cgpa }}</h1>
        </div>
      </div>

      <!-- Summary -->
      <div class="col-md-4">
        <div class="card shadow p-3 mb-4 text-center rounded-3">
          <h6>Summary</h6>
          <div class="row">
            <div class="col">
              <p class="fw-bold">{{ total_papers }}</p>
              <small>Total Papers</small>
            </div>
            <div class="col">
              <p class="fw-bold text-success">{{ passed }}</p>
              <small>Passed</small>
            </div>
            <div class="col">
              <p class="fw-bold text-danger">{{ failed }}</p>
              <small>Failed</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SGPA Line Chart -->
    <div class="card shadow p-3 mb-4 rounded-3">
      <h6>SGPA Analysis</h6>
      <canvas id="sgpaChart"></canvas>
    </div>

    <!-- Subject Marks with Semester Filter -->
    <div class="card shadow p-3 rounded-3">
      <div class="d-flex justify-content-between align-items-center">
        <h6>Marks by Subject</h6>
        <form method="get">
          <select name="semester" onchange="this.form.submit()" class="form-select w-auto">
            {% for sem in semesters %}
              <option value="{{ sem.number }}" {% if sem.number == selected_semester %}selected{% endif %}>
                Semester {{ sem.number }}
              </option>
            {% endfor %}
          </select>
        </form>
      </div>
      <div class="row mt-3">
        {% for m in marks %}
          <div class="col-md-2 text-center">
            <canvas id="chart{{ forloop.counter }}"></canvas>
            <p>{{ m.subject.name }} ({{ m.marks_obtained }}/{{ m.max_marks }})</p>
          </div>
        {% endfor %}
      </div>
    </div>
    </div>

    <script>
    // SGPA Line Chart
    var ctx = document.getElementById('sgpaChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ sgpa_labels|safe }},
        datasets: [{
          label: 'SGPA',
          data: {{ sgpa_values|safe }},
          borderColor: 'blue',
          fill: true,
          backgroundColor: 'rgba(0,0,255,0.1)'
        }]
      }
    });

    // Subject Circular Charts
    {% for m in marks %}
    var ctx{{ forloop.counter }} = document.getElementById('chart{{ forloop.counter }}').getContext('2d');
    new Chart(ctx{{ forloop.counter }}, {
      type: 'doughnut',
      data: {
        
        datasets: [{
          data: [{{ m.marks_obtained }}, {{ m.max_marks|add:"-m.marks_obtained" }}],
          backgroundColor: ['#007bff', '#e0e0e0']
        }]
      },
      options: { cutout: '70%' }
    });
    {% endfor %}
    </script>
    
    {% endif %}
    {% endblock %}
